<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodWatch - Gut Symptom Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        /* Custom scrollbar for log area */
        #log-container::-webkit-scrollbar { width: 8px; }
        #log-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-gray-50">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10 p-6 bg-white shadow-xl rounded-xl">
            <h1 class="text-4xl font-extrabold text-blue-800">FoodWatch</h1>
            <p class="text-lg text-gray-600 mt-2">Track what helps and what hurts your sensitive gut.</p>
            <p id="loading-status" class="mt-2 text-sm text-yellow-600 font-medium">Initializing application...</p>
        </header>

        <!-- Main Logging Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Food Logger Panel -->
            <div class="p-6 bg-white shadow-xl rounded-xl border border-blue-100">
                <h2 class="text-2xl font-semibold mb-6 text-blue-700">1. Log Meal & Symptoms</h2>
                
                <!-- Food Selection -->
                <div class="mb-5">
                    <label for="food-select" class="block text-sm font-medium text-gray-700 mb-2">Food Consumed:</label>
                    <select id="food-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out bg-white"></select>
                </div>
                
                <!-- Symptom Checkboxes -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Symptoms Experienced (Check all that apply):</label>
                    <div id="symptoms-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- Checkboxes will be rendered here -->
                    </div>
                </div>
                
                <!-- Log Button -->
                <button id="log-button" disabled class="w-full py-3 px-4 rounded-lg text-white font-bold transition duration-300 ease-in-out bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400">
                    Log Entry
                </button>
            </div>

            <!-- Log Display Panel -->
            <div class="p-6 bg-white shadow-xl rounded-xl border border-blue-100">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">2. Recent Logs</h2>
                <div id="log-container" class="space-y-3 h-80 overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-10" id="initial-log-message">Loading logs... Please wait for authentication.</p>
                </div>
            </div>
        </div>

        <!-- Analysis/Report Section -->
        <div class="mt-8 p-6 bg-white shadow-xl rounded-xl border border-green-100">
            <h2 class="text-2xl font-semibold mb-6 text-green-700">3. Food Trigger Analysis (Last 30 Entries)</h2>
            <div id="analysis-report" class="text-sm space-y-4">
                <p class="text-gray-500">Log more entries to generate your custom report!</p>
            </div>
        </div>
    </div>

    <!-- Modals (Add New Food) -->
    <div id="new-food-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-blue-700">Add New Food</h3>
            <input type="text" id="new-food-input" placeholder="e.g., Spicy Chicken Curry" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="py-2 px-4 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                <button id="save-new-food" class="py-2 px-4 rounded-lg bg-green-500 text-white font-medium hover:bg-green-600">Save Food</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, limit, setDoc, getDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App Variables
        let app;
        let db;
        let auth;
        let userId = null;
        const FOOD_COLLECTION = 'food_watch_foods';
        const LOG_COLLECTION = 'food_watch_logs';
        
        // --- CONSTANTS ---
        const SYMPTOMS = [
            'Bloating', 'Nausea', 'General Fatigue', 'Heartburn', 'Constipation', 
            'Flatulence', 'Intestinal Pain', 'Diarrhea', 'Headache/Migraine', 'Joint Pain'
        ];
        const ADD_NEW_FOOD_OPTION = 'add_new_food_option';

        // --- DOM ELEMENTS ---
        const foodSelect = document.getElementById('food-select');
        const symptomsList = document.getElementById('symptoms-list');
        const logButton = document.getElementById('log-button');
        const logContainer = document.getElementById('log-container');
        const analysisReport = document.getElementById('analysis-report');
        const statusMessage = document.getElementById('loading-status');
        const newFoodModal = document.getElementById('new-food-modal');
        const newFoodInput = document.getElementById('new-food-input');
        const saveNewFoodButton = document.getElementById('save-new-food');

        // --- UTILITY FUNCTIONS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        function getUserPaths(uid) {
            const userPath = `/artifacts/${appId}/users/${uid}`;
            return {
                foods: collection(db, `${userPath}/${FOOD_COLLECTION}`),
                logs: collection(db, `${userPath}/${LOG_COLLECTION}`)
            };
        }

        // --- MODAL HANDLERS ---
        window.closeModal = () => {
            newFoodModal.classList.add('hidden');
            newFoodInput.value = '';
        };

        const openModal = () => {
            newFoodModal.classList.remove('hidden');
            newFoodInput.focus();
        };

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        async function initializeFirebase() {
            try {
                // Set Firestore log level for debugging
                setLogLevel('Debug');
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // 'auth' is now defined here.
                
                // Set persistence to local to remember the session
                await setPersistence(auth, browserLocalPersistence);

                // Check for custom token
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

                // --- AUTH STATE LISTENER (MOVED HERE) ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusMessage.textContent = `Authenticated as User ID: ${userId.substring(0, 8)}...`;
                        logButton.disabled = false;
                        
                        // Start listening to data
                        setupRealtimeListeners();
                    } else {
                        userId = null;
                        statusMessage.textContent = "Waiting for user authentication...";
                        logButton.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                statusMessage.textContent = `Error initializing: ${error.message}. Check console for details.`;
            }
        }


        // --- DATA MANAGEMENT & REALTIME LISTENERS ---

        function setupRealtimeListeners() {
            if (!userId) return;
            const paths = getUserPaths(userId);

            // 1. Listen for Food List Updates
            onSnapshot(paths.foods, (snapshot) => {
                const foods = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                renderFoodDropdown(foods);
            }, (error) => console.error("Error listening to foods:", error));

            // 2. Listen for Log Updates
            const logsQuery = query(paths.logs, orderBy('timestamp', 'desc'), limit(30));
            onSnapshot(logsQuery, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLogs(logs);
                analyzeLogs(logs);
            }, (error) => console.error("Error listening to logs:", error));
        }

        // --- RENDERING FUNCTIONS ---

        function renderFoodDropdown(foods) {
            // Clear existing options
            foodSelect.innerHTML = ''; 

            if (foods.length === 0) {
                 const defaultOption = document.createElement('option');
                 defaultOption.textContent = "No foods yet. Add one below.";
                 defaultOption.value = "";
                 foodSelect.appendChild(defaultOption);
            } else {
                foods.forEach(food => {
                    const option = document.createElement('option');
                    option.value = food.name;
                    option.textContent = food.name;
                    foodSelect.appendChild(option);
                });
            }

            // Always add the 'Add New' option last
            const addNewOption = document.createElement('option');
            addNewOption.value = ADD_NEW_FOOD_OPTION;
            addNewOption.textContent = "+ Add New Food...";
            foodSelect.appendChild(addNewOption);
        }

        function renderSymptomsCheckboxes() {
            symptomsList.innerHTML = '';
            SYMPTOMS.forEach(symptom => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="symptom-${symptom.replace(/\s/g, '-')}" name="symptom" type="checkbox" value="${symptom}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="symptom-${symptom.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-600">${symptom}</label>
                `;
                symptomsList.appendChild(div);
            });
        }
        
        function renderLogs(logs) {
            logContainer.innerHTML = '';
            if (logs.length === 0) {
                logContainer.innerHTML = '<p class="text-gray-500 text-center py-10">No log entries found. Start logging now!</p>';
                return;
            }

            logs.forEach(log => {
                const date = log.timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
                const time = log.timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const symptomsText = log.symptoms.length > 0 ? log.symptoms.join(', ') : 'No symptoms reported.';
                const symptomClass = log.symptoms.length > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';

                const logCard = document.createElement('div');
                logCard.className = `p-4 rounded-lg shadow-sm transition duration-150 ${symptomClass}`;
                logCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-lg text-gray-800">${log.food}</p>
                        <span class="text-xs text-gray-500">${date} ${time}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">
                        <span class="font-semibold">${log.symptoms.length} Symptoms:</span> ${symptomsText}
                    </p>
                `;
                logContainer.appendChild(logCard);
            });
        }

        // --- ANALYSIS FUNCTION ---

        function analyzeLogs(logs) {
            if (logs.length < 5) {
                analysisReport.innerHTML = `<p class="text-gray-500">Log at least 5 entries to generate your custom report!</p>`;
                return;
            }

            const foodStats = {};
            const symptomCounts = {};
            let totalEntries = logs.length;

            // 1. Aggregate Data
            logs.forEach(log => {
                const food = log.food;
                if (!foodStats[food]) {
                    foodStats[food] = { count: 0, symptom_events: 0, symptoms: {} };
                }
                
                foodStats[food].count++;
                
                if (log.symptoms && log.symptoms.length > 0) {
                    foodStats[food].symptom_events++;
                    log.symptoms.forEach(symptom => {
                        foodStats[food].symptoms[symptom] = (foodStats[food].symptoms[symptom] || 0) + 1;
                        symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
                    });
                }
            });

            // 2. Generate Report HTML
            let reportHTML = `<p class="text-sm text-gray-700 mb-4">Based on your last ${totalEntries} entries:</p>`;

            // Foods that cause problems
            const problemFoods = Object.entries(foodStats)
                .map(([food, stats]) => ({
                    food,
                    symptomRate: (stats.symptom_events / stats.count) * 100,
                    ...stats
                }))
                .filter(item => item.symptomRate >= 20) // Only show foods that cause symptoms 20% of the time or more
                .sort((a, b) => b.symptomRate - a.symptomRate);

            if (problemFoods.length > 0) {
                reportHTML += `
                    <h4 class="font-bold text-red-700 border-b border-red-300 pb-1">ðŸ›‘ High-Risk Triggers (>20% symptom rate)</h4>
                    <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                `;
                problemFoods.forEach(item => {
                    const frequentSymptom = Object.entries(item.symptoms).sort((a, b) => b[1] - a[1])[0];
                    reportHTML += `
                        <li class="text-red-600">
                            **${item.food}** (${item.symptomRate.toFixed(0)}% of the time). Most common: ${frequentSymptom ? `${frequentSymptom[0]} (${frequentSymptom[1]}x)` : 'N/A'}
                        </li>
                    `;
                });
                reportHTML += `</ul>`;
            } else {
                 reportHTML += `<p class="text-green-600 font-semibold mt-2">âœ¨ No high-risk food triggers identified in recent logs.</p>`;
            }


            // Foods that seem safe
            const safeFoods = Object.entries(foodStats)
                .map(([food, stats]) => ({ food, symptomRate: (stats.symptom_events / stats.count) * 100 }))
                .filter(item => item.symptomRate === 0 && item.count >= 3); // Must have at least 3 logs with 0 symptoms

             if (safeFoods.length > 0) {
                reportHTML += `
                    <h4 class="font-bold text-green-700 border-b border-green-300 pb-1 mt-4">âœ… Safe Foods (0% symptom rate)</h4>
                    <ul class="list-disc list-inside ml-4 space-y-1 mt-2">
                `;
                safeFoods.forEach(item => {
                    reportHTML += `<li class="text-green-600">${item.food} (${item.count} total logs)</li>`;
                });
                reportHTML += `</ul>`;
            }

            analysisReport.innerHTML = reportHTML;
        }

        // --- EVENT HANDLERS ---

        function handleFoodSelectChange(event) {
            if (event.target.value === ADD_NEW_FOOD_OPTION) {
                openModal();
            }
        }

        async function saveNewFood() {
            const foodName = newFoodInput.value.trim();
            if (!foodName) return;

            if (!userId) {
                console.error("User not authenticated to save food.");
                return;
            }

            const paths = getUserPaths(userId);
            try {
                // Check if food already exists (optional, but good practice)
                const docRef = doc(paths.foods, foodName.toLowerCase().replace(/\s/g, '_'));
                const docSnap = await getDoc(docRef);

                // IMPORTANT: Since we moved away from alert(), let's use the modal itself to display a message
                if (docSnap.exists()) {
                     // Create a temporary element in the modal to show the message
                     const messageEl = document.createElement('p');
                     messageEl.textContent = `Error: The food '${foodName}' already exists.`;
                     messageEl.className = 'text-red-500 text-sm mb-2';
                     newFoodInput.parentNode.insertBefore(messageEl, newFoodInput.nextSibling);

                     setTimeout(() => {
                         messageEl.remove();
                     }, 3000);
                     return;
                }
                
                await setDoc(docRef, { 
                    name: foodName, 
                    timestamp: new Date() 
                });
                
                closeModal();
                foodSelect.value = foodName; // Select the newly added food
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        async function logEntry() {
            const selectedFood = foodSelect.value;
            if (!selectedFood || selectedFood === ADD_NEW_FOOD_OPTION) {
                // IMPORTANT: Since we moved away from alert(), we need a non-alert message system.
                // For simplicity here, we'll just log an error to the console and briefly change the button text.
                logButton.textContent = 'Please select a food!';
                logButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                logButton.classList.add('bg-red-500');
                 setTimeout(() => {
                    logButton.textContent = 'Log Entry';
                    logButton.classList.remove('bg-red-500');
                    logButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 1500);
                return;
            }

            const checkedSymptoms = Array.from(document.querySelectorAll('input[name="symptom"]:checked'))
                .map(checkbox => checkbox.value);

            if (!userId) {
                console.error("User not authenticated to log entry.");
                return;
            }
            
            const paths = getUserPaths(userId);

            try {
                await addDoc(paths.logs, {
                    food: selectedFood,
                    symptoms: checkedSymptoms,
                    timestamp: new Date()
                });

                // Success feedback and reset
                logButton.textContent = 'Logged! (Resetting...)';
                logButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                logButton.classList.add('bg-green-500');
                
                // Clear symptoms checkboxes
                document.querySelectorAll('input[name="symptom"]:checked').forEach(cb => cb.checked = false);

                setTimeout(() => {
                    logButton.textContent = 'Log Entry';
                    logButton.classList.remove('bg-green-500');
                    logButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 1500);

            } catch (e) {
                console.error("Error logging entry: ", e);
                // Simple feedback for error
                logButton.textContent = 'Error! See console.';
            }
        }


        // --- SETUP CALLS ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSymptomsCheckboxes();
            // initializeFirebase() will now handle auth status changes internally
            initializeFirebase(); 
            
            // Event Listeners
            foodSelect.addEventListener('change', handleFoodSelectChange);
            logButton.addEventListener('click', logEntry);
            saveNewFoodButton.addEventListener('click', saveNewFood);
            
            // Allow pressing Enter to save food in modal
            newFoodInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveNewFood();
                }
            });
        });

    </script>
</body>
</html>
